<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Cross-Validation Test for Treatment Effect Heterogeneity — margot_rate_cv • margot</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Fira_Code-0.4.10/font.css" rel="stylesheet"><link href="../deps/Fira_Sans-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cross-Validation Test for Treatment Effect Heterogeneity — margot_rate_cv"><meta name="description" content="Performs uncorrelated sequential cross-validation to test for treatment effect
heterogeneity using the approach recommended by the grf package (Wager 2024).
This method provides robust statistical testing that avoids overfitting by using
sequential, non-overlapping training sets."><meta property="og:description" content="Performs uncorrelated sequential cross-validation to test for treatment effect
heterogeneity using the approach recommended by the grf package (Wager 2024).
This method provides robust statistical testing that avoids overfitting by using
sequential, non-overlapping training sets."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">margot</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.227</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/go-bayes/margot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Cross-Validation Test for Treatment Effect Heterogeneity</h1>
      <small class="dont-index">Source: <a href="https://github.com/go-bayes/margot/blob/HEAD/R/margot_rate_cv.R" class="external-link"><code>R/margot_rate_cv.R</code></a></small>
      <div class="d-none name"><code>margot_rate_cv.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Performs uncorrelated sequential cross-validation to test for treatment effect
heterogeneity using the approach recommended by the grf package (Wager 2024).
This method provides robust statistical testing that avoids overfitting by using
sequential, non-overlapping training sets.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">margot_rate_cv</span><span class="op">(</span></span>
<span>  <span class="va">model_results</span>,</span>
<span>  num_folds <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AUTOC"</span>, <span class="st">"QINI"</span><span class="op">)</span>,</span>
<span>  model_names <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  use_full_data <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">12345</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>  future_globals_maxSize <span class="op">=</span> <span class="fl">22</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  adjust <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>  label_mapping <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-model-results">model_results<a class="anchor" aria-label="anchor" href="#arg-model-results"></a></dt>
<dd><p>Output from `margot_causal_forest()` or `margot_flip_forests()`</p></dd>


<dt id="arg-num-folds">num_folds<a class="anchor" aria-label="anchor" href="#arg-num-folds"></a></dt>
<dd><p>Integer. Number of cross-validation folds (default 5). Must be at least 3.</p></dd>


<dt id="arg-target">target<a class="anchor" aria-label="anchor" href="#arg-target"></a></dt>
<dd><p>Character vector. RATE targets to test: "AUTOC", "QINI", or
c("AUTOC", "QINI") for both (default). When both are specified, results
are combined with adjusted p-values accounting for testing both metrics.</p></dd>


<dt id="arg-model-names">model_names<a class="anchor" aria-label="anchor" href="#arg-model-names"></a></dt>
<dd><p>Character vector. Specific models to test (default NULL tests all)</p></dd>


<dt id="arg-use-full-data">use_full_data<a class="anchor" aria-label="anchor" href="#arg-use-full-data"></a></dt>
<dd><p>Logical. If TRUE and data is available, refit forests on full data
rather than using the training split (default TRUE)</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Integer or NULL. Random seed for reproducibility. If NULL, defaults to 12345</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical. Print progress messages (default TRUE)</p></dd>


<dt id="arg-parallel">parallel<a class="anchor" aria-label="anchor" href="#arg-parallel"></a></dt>
<dd><p>Logical. Use parallel processing for multiple models (default FALSE).
Note: Parallel processing requires the margot package to be installed (not just loaded
with devtools::load_all()). If the package is not installed, the function will fall
back to sequential processing with a warning.</p></dd>


<dt id="arg-n-cores">n_cores<a class="anchor" aria-label="anchor" href="#arg-n-cores"></a></dt>
<dd><p>Integer. Number of cores for parallel processing when parallel = TRUE
(default all cores - 1)</p></dd>


<dt id="arg-future-globals-maxsize">future_globals_maxSize<a class="anchor" aria-label="anchor" href="#arg-future-globals-maxsize"></a></dt>
<dd><p>Numeric. Maximum allowed size for exporting globals to
parallel workers in GiB. Default is 22. Set to Inf to disable the limit.</p></dd>


<dt id="arg-alpha">alpha<a class="anchor" aria-label="anchor" href="#arg-alpha"></a></dt>
<dd><p>Numeric. Significance level for hypothesis tests (default 0.05).
When using Bonferroni correction, consider alpha = 0.2 due to its conservative nature.</p></dd>


<dt id="arg-adjust">adjust<a class="anchor" aria-label="anchor" href="#arg-adjust"></a></dt>
<dd><p>Character. Multiple testing adjustment method. Only "bonferroni" or "none"
are valid for cross-validation due to the martingale aggregation method. Default is "none".
Other methods like BH/BY/FDR are not statistically appropriate for CV aggregation.</p></dd>


<dt id="arg-label-mapping">label_mapping<a class="anchor" aria-label="anchor" href="#arg-label-mapping"></a></dt>
<dd><p>Optional named list for custom label mappings. Keys should be model names
(with or without "model_" prefix), and values should be the desired display labels.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to grf::causal_forest</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list containing:</p>
<dl><dt>cv_results</dt>
<dd><p>Data frame with CV test results for each model</p></dd>

  <dt>interpretation</dt>
<dd><p>Character string interpreting the results</p></dd>

  <dt>significant_models</dt>
<dd><p>Character vector of models with significant heterogeneity</p></dd>

  <dt>tables</dt>
<dd><p>List of formatted tables similar to margot_rate() output (rate_autoc, rate_qini)</p></dd>

  <dt>method_details</dt>
<dd><p>List with details about the CV procedure</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function implements the sequential cross-validation approach from
Wager (2024) and Nie &amp; Wager (2020). This method:
- Splits data into K folds
- Trains on folds 1 to k-1, tests on fold k
- Aggregates t-statistics using the martingale property
- Provides valid p-values for heterogeneity testing</p>
<p>The null hypothesis is that there is no treatment effect heterogeneity
(all individuals have the same treatment effect).</p>
<p>## Multiple Testing Correction</p>
<p>Due to the martingale aggregation method used in CV, only Bonferroni correction
or no correction are statistically valid. Methods like Benjamini-Hochberg (BH)
or false discovery rate (FDR) control are not appropriate because they assume
independent p-values, which is violated by the sequential CV structure.</p>
<p>Bonferroni correction is very conservative, especially with noisy heterogeneous
treatment effect models. We recommend using alpha = 0.2 when applying Bonferroni
correction to maintain reasonable statistical power.</p>
<p>For memory efficiency with large model objects, the function pre-extracts
only the necessary data for each model before parallel processing. However,
parallel processing is currently experimental and disabled by default due to
potential memory issues with large model objects. If you want to try parallel
processing, set parallel = TRUE and consider increasing the future.globals.maxSize
option with: options(future.globals.maxSize = 15 * 1024^3) # 15 GB</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Wager, S. (2024). Sequential validation for heterogeneous treatment effects.
arXiv preprint arXiv:2401.06818.</p>
<p>Nie, X., &amp; Wager, S. (2021). Quasi-oracle estimation of heterogeneous treatment effects.
Biometrika, 108(2), 299-319.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Run causal forest</span></span></span>
<span class="r-in"><span><span class="va">cf_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="margot_causal_forest.html">margot_causal_forest</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">mydata</span>,</span></span>
<span class="r-in"><span>  outcome_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"outcome1"</span>, <span class="st">"outcome2"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  covariates <span class="op">=</span> <span class="va">covariates</span>,</span></span>
<span class="r-in"><span>  W <span class="op">=</span> <span class="va">treatment</span>,</span></span>
<span class="r-in"><span>  save_data <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># Important for CV</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Test for heterogeneity with cross-validation (both targets by default)</span></span></span>
<span class="r-in"><span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu">margot_rate_cv</span><span class="op">(</span></span></span>
<span class="r-in"><span>  model_results <span class="op">=</span> <span class="va">cf_results</span>,</span></span>
<span class="r-in"><span>  num_folds <span class="op">=</span> <span class="fl">5</span>,</span></span>
<span class="r-in"><span>  alpha <span class="op">=</span> <span class="fl">0.2</span>, <span class="co"># recommended with Bonferroni</span></span></span>
<span class="r-in"><span>  adjust <span class="op">=</span> <span class="st">"bonferroni"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># With custom labels</span></span></span>
<span class="r-in"><span><span class="va">label_mapping</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">"model_happiness"</span> <span class="op">=</span> <span class="st">"Happiness"</span>,</span></span>
<span class="r-in"><span>  <span class="st">"model_depression"</span> <span class="op">=</span> <span class="st">"Depression"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu">margot_rate_cv</span><span class="op">(</span></span></span>
<span class="r-in"><span>  model_results <span class="op">=</span> <span class="va">cf_results</span>,</span></span>
<span class="r-in"><span>  label_mapping <span class="op">=</span> <span class="va">label_mapping</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Test single target only</span></span></span>
<span class="r-in"><span><span class="va">cv_results_autoc</span> <span class="op">&lt;-</span> <span class="fu">margot_rate_cv</span><span class="op">(</span></span></span>
<span class="r-in"><span>  model_results <span class="op">=</span> <span class="va">cf_results</span>,</span></span>
<span class="r-in"><span>  target <span class="op">=</span> <span class="st">"AUTOC"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View results</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">cv_results</span><span class="op">$</span><span class="va">interpretation</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Access formatted tables (similar to margot_rate output)</span></span></span>
<span class="r-in"><span><span class="va">cv_results</span><span class="op">$</span><span class="va">tables</span><span class="op">$</span><span class="va">rate_autoc</span> <span class="co"># AUTOC table</span></span></span>
<span class="r-in"><span><span class="va">cv_results</span><span class="op">$</span><span class="va">tables</span><span class="op">$</span><span class="va">rate_qini</span> <span class="co"># QINI table</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get detailed interpretation with tables (similar to margot_interpret_rate)</span></span></span>
<span class="r-in"><span><span class="va">detailed_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="margot_interpret_rate_cv.html">margot_interpret_rate_cv</a></span><span class="op">(</span><span class="va">cv_results</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">detailed_results</span><span class="op">$</span><span class="va">interpretation</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View individual target interpretations</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">detailed_results</span><span class="op">$</span><span class="va">autoc_results</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">detailed_results</span><span class="op">$</span><span class="va">qini_results</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Comparison between AUTOC and QINI</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">detailed_results</span><span class="op">$</span><span class="va">comparison</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">detailed_results</span><span class="op">$</span><span class="va">comparison</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create visualization</span></span></span>
<span class="r-in"><span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="margot_plot_cv_results.html">margot_plot_cv_results</a></span><span class="op">(</span><span class="va">cv_results</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/go-bayes" class="external-link">Joseph A Bulbulia</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

