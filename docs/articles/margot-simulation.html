<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulating Longitudinal Data • margot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Fira_Code-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Fira_Sans-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulating Longitudinal Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">margot</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.201</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/go-bayes/margot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="margot-simulation_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="margot-simulation_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="margot-simulation_files/viz-1.8.2/viz.js"></script><link href="margot-simulation_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="margot-simulation_files/grViz-binding-1.0.11/grViz.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulating Longitudinal Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/go-bayes/margot/blob/HEAD/vignettes/margot-simulation.Rmd" class="external-link"><code>vignettes/margot-simulation.Rmd</code></a></small>
      <div class="d-none name"><code>margot-simulation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://go-bayes.github.io/margot">margot</a></span><span class="op">)</span>   <span class="co"># core simulation + estimation tools</span></span>
<span><span class="co">#&gt; margot 1.0.201</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>    <span class="co"># tidy manipulation</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>    <span class="co"># data reshaping</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>  <span class="co"># graphics for examples</span></span></code></pre></div>
<div class="section level2">
<h2 id="why-simulate-longitudinal-data">1. Why simulate longitudinal data?<a class="anchor" aria-label="anchor" href="#why-simulate-longitudinal-data"></a>
</h2>
<p>Synthetic panel data with <em>known</em> data-generating mechanisms
are invaluable for</p>
<ul>
<li>
<strong>Teaching</strong>: illustrate causal ideas where the ground
truth is visible;</li>
<li>
<strong>Software testing</strong>: ensure estimators recover the
truth under controlled violations;</li>
<li>
<strong>Power &amp; design</strong>: gauge sample-size or
wave-number requirements;</li>
<li>
<strong>Method development</strong>: iterate quickly without large,
confidential datasets.</li>
</ul>
<p><code><a href="../reference/margot_simulate.html">margot_simulate()</a></code> is our workhorse; the sections below
unpack its interface and demonstrate common scenarios.</p>
</div>
<div class="section level2">
<h2 id="anatomy-of-margot_simulate">2. Anatomy of <code>margot_simulate()</code><a class="anchor" aria-label="anchor" href="#anatomy-of-margot_simulate"></a>
</h2>
<p>The simulator draws baseline covariates <strong>B</strong>,
time-varying covariates <strong>L</strong>, exposures
<strong>A</strong>, and lead outcomes <strong>Y</strong> across a
user-specified number of waves. <em>Figure 1</em> gives a high-level
schematic.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># build a toy DAG with DiagrammeR for illustration only (not evaluated when package is built)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"DiagrammeR"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rich-iannone.github.io/DiagrammeR/reference/grViz.html" class="external-link">grViz</a></span><span class="op">(</span></span>
<span>    <span class="st">"digraph {graph [rankdir = LR, bgcolor = none]</span></span>
<span><span class="st">      node [shape = box, fontname = Helvetica]</span></span>
<span><span class="st">      subgraph cluster0 {label = \"Wave 0\"; style = dashed; B; t0_L;}</span></span>
<span><span class="st">      subgraph cluster1 {label = \"Wave 1\"; style = dashed; t1_A; t1_L; t1_Y;}</span></span>
<span><span class="st">      subgraph cluster2 {label = \"Wave 2\"; style = dashed; t2_A; t2_L; t2_Y;}</span></span>
<span><span class="st">      B -&gt; t1_L -&gt; t1_A -&gt; t1_Y</span></span>
<span><span class="st">      B -&gt; t1_A</span></span>
<span><span class="st">      t1_Y -&gt; t2_A [style = dashed]  // optional y_feedback</span></span>
<span><span class="st">      t1_A -&gt; t2_L [style = dashed]  // covar_feedback</span></span>
<span><span class="st">      t1_A -&gt; censor1 [style = dashed]</span></span>
<span><span class="st">      censor1 [shape = circle, label = \"C\"]</span></span>
<span><span class="st">    }"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<div class="grViz html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"diagram":"digraph {graph [rankdir = LR, bgcolor = none]\n      node [shape = box, fontname = Helvetica]\n      subgraph cluster0 {label = \"Wave 0\"; style = dashed; B; t0_L;}\n      subgraph cluster1 {label = \"Wave 1\"; style = dashed; t1_A; t1_L; t1_Y;}\n      subgraph cluster2 {label = \"Wave 2\"; style = dashed; t2_A; t2_L; t2_Y;}\n      B -> t1_L -> t1_A -> t1_Y\n      B -> t1_A\n      t1_Y -> t2_A [style = dashed]  // optional y_feedback\n      t1_A -> t2_L [style = dashed]  // covar_feedback\n      t1_A -> censor1 [style = dashed]\n      censor1 [shape = circle, label = \"C\"]\n    }","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p class="caption">
Figure 1: data-generating process underlying
<code><a href="../reference/margot_simulate.html">margot_simulate()</a></code>. Solid arrows are structural paths;
dashed arrows indicate optional feedback loops and censoring.
</p>
</div>
<p>Key arguments (non-exhaustive):</p>
<table class="table">
<colgroup>
<col width="20%">
<col width="64%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th>Argument</th>
<th>Purpose</th>
<th>Typical values</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>n</code></td>
<td>number of individuals</td>
<td>100–10 000</td>
</tr>
<tr class="even">
<td><code>waves</code></td>
<td>follow-up waves (outcomes measured at <code>waves + 1</code>)</td>
<td>3–10</td>
</tr>
<tr class="odd">
<td><code>p_covars</code></td>
<td># of time-varying <strong>L</strong> covariates</td>
<td>0–5</td>
</tr>
<tr class="even">
<td><code>exposures</code></td>
<td>list describing each <strong>A</strong> variable</td>
<td>see §3</td>
</tr>
<tr class="odd">
<td><code>outcomes</code></td>
<td>list describing <strong>Y</strong> variables</td>
<td>rarely needed</td>
</tr>
<tr class="even">
<td><code>y_feedback</code></td>
<td>strength of <em>Y → A</em> path (0 disables)</td>
<td>0–1</td>
</tr>
<tr class="odd">
<td><code>censoring</code></td>
<td>dropout mechanism: <code>rate</code>,
<code>exposure_dependence</code>, …</td>
<td>list</td>
</tr>
<tr class="even">
<td><code>item_missing_rate</code></td>
<td>MCAR missingness on observed values</td>
<td>0–0.5</td>
</tr>
<tr class="odd">
<td><code>wide</code></td>
<td>return wide format (TRUE recommended; long format under
development)</td>
<td>TRUE</td>
</tr>
</tbody>
</table>
<p>The default coefficient set is returned by
<code>.default_sim_params()</code>. Supply a named list to the
<code>params</code> argument to override any subset.</p>
</div>
<div class="section level2">
<h2 id="worked-examples">3. Worked examples<a class="anchor" aria-label="anchor" href="#worked-examples"></a>
</h2>
<div class="section level3">
<h3 id="baseline-simple-continuous-outcome">3.1 Baseline: simple continuous outcome<a class="anchor" aria-label="anchor" href="#baseline-simple-continuous-outcome"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate data in wide format (default)</span></span>
<span><span class="va">basic_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/margot_simulate.html">margot_simulate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">500</span>, waves <span class="op">=</span> <span class="fl">3</span>, seed <span class="op">=</span> <span class="fl">2025</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># examine structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">basic_dat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; tibble [500 × 10] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ id: int [1:500] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">#&gt;  $ B1: num [1:500] -0.792 1.332 -0.245 -1.159 -1.712 ...</span></span>
<span><span class="co">#&gt;  $ B2: num [1:500] 0.73 -1.733 0.283 -1.453 -0.11 ...</span></span>
<span><span class="co">#&gt;  $ B3: num [1:500] 0.306 -2.069 -1.352 -2.105 -1.475 ...</span></span>
<span><span class="co">#&gt;  $ B4: num [1:500] -0.647 0.231 -1.929 -0.545 0.299 ...</span></span>
<span><span class="co">#&gt;  $ B5: num [1:500] -0.376 -0.302 -1.994 -0.312 -0.3 ...</span></span>
<span><span class="co">#&gt;  $ B6: num [1:500] -0.201 -0.427 -0.402 -0.418 0.278 ...</span></span>
<span><span class="co">#&gt;  $ B7: num [1:500] 0.128 1.205 -0.959 -1.054 -2.097 ...</span></span>
<span><span class="co">#&gt;  $ B8: num [1:500] 0.206 0.174 -0.49 -0.459 0.583 ...</span></span>
<span><span class="co">#&gt;  $ B9: num [1:500] -1.0513 0.0444 0.6933 0.0259 -0.7786 ...</span></span>
<span><span class="co">#&gt;  - attr(*, "margot_meta")=List of 2</span></span>
<span><span class="co">#&gt;   ..$ args     : language margot_simulate(n = 500, waves = 3, seed = 2025)</span></span>
<span><span class="co">#&gt;   ..$ timestamp: POSIXct[1:1], format: "2025-07-29 09:51:48"</span></span>
<span></span>
<span><span class="co"># summarize treatment and outcome</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">basic_dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"t1_A1"</span>, <span class="st">"t2_A1"</span>, <span class="st">"t3_A1"</span>, <span class="st">"t4_Y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;      t1_A1            t2_A1            t3_A1             t4_Y        </span></span>
<span><span class="co">#&gt;  Min.   :0.0000   Min.   :0.0000   Min.   :0.0000   Min.   :-2.4453  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:-0.5044  </span></span>
<span><span class="co">#&gt;  Median :0.0000   Median :0.0000   Median :0.0000   Median : 0.1533  </span></span>
<span><span class="co">#&gt;  Mean   :0.4423   Mean   :0.4652   Mean   :0.3641   Mean   : 0.1401  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.: 0.9146  </span></span>
<span><span class="co">#&gt;  Max.   :1.0000   Max.   :1.0000   Max.   :1.0000   Max.   : 2.7243  </span></span>
<span><span class="co">#&gt;  NA's   :136      NA's   :227      NA's   :305      NA's   :363</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="heterogeneous-treatment-effects-effect-modification">3.2 Heterogeneous treatment effects (effect modification)<a class="anchor" aria-label="anchor" href="#heterogeneous-treatment-effects-effect-modification"></a>
</h3>
<p>Suppose the causal effect of exposure <code>A1</code> varies with
baseline covariate <code>B2</code>. We encode this via the
<code>het</code> sub-list:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">het_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/margot_simulate.html">margot_simulate</a></span><span class="op">(</span></span>
<span>  n        <span class="op">=</span> <span class="fl">4000</span>,</span>
<span>  waves    <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  exposures <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    A1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"binary"</span>,</span>
<span>      het  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>modifier <span class="op">=</span> <span class="st">"B2"</span>,  <span class="co"># effect modifier</span></span>
<span>                  coef     <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span>    <span class="co"># γ: interaction strength</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  exposure_outcome <span class="op">=</span> <span class="fl">0.4</span>,  <span class="co"># marginal main effect β</span></span>
<span>  seed <span class="op">=</span> <span class="fl">2027</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Verify the interaction:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_het</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">t4_Y</span> <span class="op">~</span> <span class="va">t3_A1</span> <span class="op">*</span> <span class="va">B2</span>, data <span class="op">=</span> <span class="va">het_dat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_het</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span></span>
<span><span class="co">#&gt;               Estimate Std. Error    t value     Pr(&gt;|t|)</span></span>
<span><span class="co">#&gt; (Intercept) 0.01650478 0.03845638  0.4291819 6.678640e-01</span></span>
<span><span class="co">#&gt; t3_A1       0.42220419 0.05588604  7.5547343 8.019120e-14</span></span>
<span><span class="co">#&gt; B2          0.07359943 0.03916117  1.8793981 6.042006e-02</span></span>
<span><span class="co">#&gt; t3_A1:B2    0.72038968 0.05588497 12.8905800 8.232715e-36</span></span></code></pre></div>
<blockquote>
<p><strong>Take-away.</strong> The interaction term
(<code>t3_A1:B2</code>) recovers<br><span class="math inline">$\\beta_{\\text{het}} \\approx 0.6$</span>,
matching the data-generating value.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="outcome-treatment-feedback">3.3 Outcome → Treatment feedback<a class="anchor" aria-label="anchor" href="#outcome-treatment-feedback"></a>
</h3>
<p>Realistic behavioural processes often exhibit reflexivity: past
outcomes influence future treatment uptake. Let’s compare simulations
with and without <code>y_feedback</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Without feedback</span></span>
<span><span class="va">no_fb_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/margot_simulate.html">margot_simulate</a></span><span class="op">(</span></span>
<span>  n          <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  waves      <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  y_feedback <span class="op">=</span> <span class="fl">0</span>,     <span class="co"># no Y → A dependency</span></span>
<span>  wide       <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed       <span class="op">=</span> <span class="fl">101</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># With feedback</span></span>
<span><span class="va">fb_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/margot_simulate.html">margot_simulate</a></span><span class="op">(</span></span>
<span>  n           <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  waves       <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  y_feedback  <span class="op">=</span> <span class="fl">0.8</span>,   <span class="co"># strong Y → A dependency</span></span>
<span>  params      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>exp_L1_coef <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>, <span class="co"># optional A → L feedback</span></span>
<span>  wide        <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed        <span class="op">=</span> <span class="fl">101</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Let’s examine how y_feedback affects treatment patterns:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate treatment rates for both datasets</span></span>
<span><span class="va">get_treatment_rates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">label</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"t"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"_A1"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"wave_var"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"prop_treated"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      wave <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"t([0-9]+)_A1"</span>, <span class="st">"\\1"</span>, <span class="va">wave_var</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      feedback <span class="op">=</span> <span class="va">label</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine rates from both simulations</span></span>
<span><span class="va">combined_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu">get_treatment_rates</span><span class="op">(</span><span class="va">no_fb_dat</span>, <span class="st">"No feedback"</span><span class="op">)</span>,</span>
<span>  <span class="fu">get_treatment_rates</span><span class="op">(</span><span class="va">fb_dat</span>, <span class="st">"With feedback (0.8)"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the comparison</span></span>
<span><span class="va">combined_rates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">wave</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">feedback</span>, values_from <span class="op">=</span> <span class="va">prop_treated</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">wave</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;   wave_var  wave `No feedback` `With feedback (0.8)`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> t1_A1        1         0.444                 0.444</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> t2_A1        2         0.458                 0.447</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> t3_A1        3         0.452                 0.438</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> t4_A1        4         0.438                 0.424</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> t5_A1        5         0.477                 0.456</span></span></code></pre></div>
<p>Visualise treatment rates across waves:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot comparison</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">combined_rates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">wave</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">wave</span>, y <span class="op">=</span> <span class="va">prop_treated</span>, color <span class="op">=</span> <span class="va">feedback</span>, group <span class="op">=</span> <span class="va">feedback</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Treatment Assignment Rates Across Waves"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Comparing simulations with and without outcome feedback"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Wave"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Proportion Treated"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Simulation"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No feedback"</span> <span class="op">=</span> <span class="st">"darkgray"</span>, </span>
<span>                                <span class="st">"With feedback (0.8)"</span> <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="margot-simulation_files/figure-html/feedback-plot-1.png" alt="Comparison of treatment probability trends" width="672"></p>
<p>Note: The <code>y_feedback</code> parameter affects how past outcomes
influence future treatment assignment. The specific pattern depends on
the interaction between outcome values, baseline covariates, and the
simulation parameters. In practice, y_feedback creates time-varying
confounding by making treatment assignment depend on past outcomes.</p>
</div>
</div>
<div class="section level2">
<h2 id="positivity-diagnostics">3.4 Positivity diagnostics<a class="anchor" aria-label="anchor" href="#positivity-diagnostics"></a>
</h2>
<p>Estimators grounded in the g-formula, IPW, or TMLE require sufficient
overlap (positivity) of treatment probabilities across strata of
measured covariates. Below we inspect estimated propensity scores at the
final observed wave in the heterogeneous-effects example.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># wave-3 propensity model: A1 ~ B2</span></span>
<span><span class="co"># Filter to complete cases for this analysis</span></span>
<span><span class="va">het_complete</span> <span class="op">&lt;-</span> <span class="va">het_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">t3_A1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">B2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ps_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">t3_A1</span> <span class="op">~</span> <span class="va">B2</span>, family <span class="op">=</span> <span class="va">binomial</span>, data <span class="op">=</span> <span class="va">het_complete</span><span class="op">)</span></span>
<span><span class="va">het_complete</span><span class="op">$</span><span class="va">ps3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ps_mod</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">het_complete</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ps3</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">t3_A1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"identity"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span>, bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x    <span class="op">=</span> <span class="st">"estimated propensity score"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"A1 at wave 3"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="margot-simulation_files/figure-html/positivity-plot-1.png" alt="Histogram showing propensity score distributions for treated and control groups with good overlap" width="672"></p>
</div>
<div class="section level2">
<h2 id="censoring-missingness">4. Censoring &amp; missingness<a class="anchor" aria-label="anchor" href="#censoring-missingness"></a>
</h2>
<p>Attrition can depend on exposure, a latent frailty shared within
individuals, or both. For brevity, see the dedicated <em>Censoring</em>
vignette.</p>
</div>
<div class="section level2">
<h2 id="power-analysis-template">5. Power analysis template<a class="anchor" aria-label="anchor" href="#power-analysis-template"></a>
</h2>
<p>Combined heterogeneity and feedback can inflate sample-size
requirements. Use batched simulations to trace operating
characteristics; skeleton:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>power_grid <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">N =</span> <span class="fu">seq</span>(<span class="dv">500</span>, <span class="dv">5000</span>, <span class="at">by =</span> <span class="dv">500</span>))</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>power_grid<span class="sc">$</span>power <span class="ot">&lt;-</span> <span class="fu">vapply</span>(power_grid<span class="sc">$</span>N, <span class="cf">function</span>(n) {</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">replicate</span>(<span class="dv">300</span>, {</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">margot_simulate</span>(<span class="at">n =</span> n, <span class="at">waves =</span> <span class="dv">4</span>,</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>                           <span class="at">y_feedback =</span> <span class="fl">0.7</span>,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>                           <span class="at">exposures =</span> <span class="fu">list</span>(<span class="at">A1 =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">"binary"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>                                                      <span class="at">het =</span> <span class="fu">list</span>(<span class="at">modifier =</span> <span class="st">"B1"</span>, <span class="at">coef =</span> <span class="fl">0.5</span>))),</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>                           <span class="at">exposure_outcome =</span> <span class="fl">0.3</span>, <span class="at">wide =</span> <span class="cn">TRUE</span>)<span class="er">)</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    <span class="fu">t.test</span>(t5_Y <span class="sc">~</span> t3_A1, <span class="at">data =</span> dat)<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  }))</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>}, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="fu">ggplot</span>(power_grid, <span class="fu">aes</span>(N, power)) <span class="sc">+</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Power"</span>, <span class="at">x =</span> <span class="st">"Sample size"</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="further-reading">6. Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li>
<em>Hernán &amp; Robins (2020)</em> — <em>Causal Inference: What
If</em>.</li>
<li>
<em>Daniel et al. (2013)</em> — methods for time-varying
confounding.</li>
</ul>
<hr>
<p>Happy simulating — and remember to set a seed.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/go-bayes" class="external-link">Joseph A Bulbulia</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
