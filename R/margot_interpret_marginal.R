#' Interpret and Describe Causal Effect Estimates Using E-values
#'
#' This function interprets the output of causal effect analysis, providing textual descriptions
#' of causal effect estimates. It categorises the strength of evidence for causality based on
#' E-values and confidence intervals, and generates a detailed interpretation of the effect
#' estimates according to specified types (i.e., "RD" for risk difference or "RR" for risk ratio)
#' and estimands.
#'
#' @param df Data frame containing causal effect estimates, expected to include columns for
#' outcome names, effect estimates (either differences or ratios), confidence intervals,
#' E-values, and a summary estimate label.
#' @param type Character string specifying the type of effect estimate. Must be either "RD"
#' (Risk Difference) or "RR" (Risk Ratio). Default is "RD".
#' @param estimand Optional character string indicating the type of causal estimand interpreted: "PATE"
#' (Population Average Treatment Effect), "ATE" (Average Treatment Effect), "ATT" (Average
#' Treatment Effect in the Treated), "CATE" (Conditional Average Treatment Effect), or "LMTP"
#' (Longitudinal Modified Treatment Policy). Default is NULL.
#' @param order Character string specifying the order of results. Default is "default".
#'
#' @return A list containing two elements:
#'   \item{estimand_description}{A character string describing the specified estimand, or NULL if no estimand was provided.}
#'   \item{interpretation}{A character string containing a detailed interpretation of each outcome in `df`,
#'   including the causal contrast, E-values, and the strength of evidence for causality.}
#'
#' @examples
#' \dontrun{
#' # Assuming `group_tab_output` is the result from a causal analysis
#' result <- margot_interpret_marginal(group_tab_output, type = "RD", estimand = "ATE")
#' cat(result$estimand_description)
#' cat(result$interpretation)
#'
#' # Using Risk Ratio without specifying an estimand
#' result <- margot_interpret_marginal(group_tab_output, type = "RR")
#' cat(result$interpretation)
#' }
#'
#' @export
#' @importFrom dplyr case_when mutate rowwise ungroup if_else
#' @importFrom glue glue
#' @importFrom cli cli_alert_info cli_alert_success cli_alert_warning
margot_interpret_marginal <- function(df, type = c("RD", "RR"), estimand = NULL, order = "default") {
  require(dplyr)
  require(glue)
  require(tibble)
  require(cli)

  type <- match.arg(type)

  cli_alert_info("Starting interpretation of causal effect estimates...")

  # Define estimand descriptions
  estimand_description <- if (!is.null(estimand)) {
    dplyr::case_when(
      estimand == "LMTP" ~ "A Longitudinal Modified Treatment Policy (LMTP) calculates the expected outcome difference between treatment and contrast conditions over a sequential regime of treatments for a prespecified target population.",
      estimand == "PATE" ~ "The Population Average Treatment Effect (PATE) estimates the expected outcome difference between treatment and contrast groups across the entire New Zealand population.",
      estimand == "ATE" ~ "The Average Treatment Effect (ATE) measures the mean difference in outcomes between treatment and contrast groups within the target population.",
      estimand == "ATT" ~ "The Average Treatment Effect on the Treated (ATT) assesses the expected outcome difference for those receiving the treatment, compared to a similar group that did not, within the target population.",
      estimand == "CATE" ~ "The Conditional Average Treatment Effect (CATE) evaluates the expected difference in outcomes between treatment and contrast groups within specific population strata.",
      TRUE ~ "The specified estimand is not recognized. Valid options include: 'PATE', 'ATE', 'ATT', 'CATE', 'LMTP'."
    )
  } else {
    NULL
  }

  # Use group_tab to ensure the dataframe is correctly formatted
  if (!"Estimate" %in% names(df) || !"outcome" %in% names(df)) {
    cli_alert_info("Formatting input data...")
    df <- group_tab(df, type = type, order = order)
  }

  # Determine the correct causal contrast column based on type
  causal_contrast_column <- if (type == "RD") {
    "E[Y(1)]-E[Y(0)]"
  } else {
    "E[Y(1)]/E[Y(0)]"
  }

  # Check if the required column exists
  if (!causal_contrast_column %in% names(df)) {
    cli_alert_danger(paste("Dataframe does not contain the required column:", causal_contrast_column))
    stop(paste("Dataframe does not contain the required column:", causal_contrast_column))
  }

  cli_alert_info("Processing and interpreting data...")

  # Data processing and interpretation
  interpretation <- df %>%
    dplyr::mutate(
      causal_contrast = round(.data[[causal_contrast_column]], 3),
      formatted_strength = case_when(
        E_Val_bound <= 1 | (`2.5 %` <= 0 & `97.5 %` >= 0) ~ cli::col_red("**the evidence for causality is not reliable**"),
        E_Val_bound > 1 & E_Val_bound < 1.1 ~ cli::col_yellow("**the evidence for causality is weak**"),
        E_Val_bound > 2 ~ cli::col_green("**the evidence for causality is strong**"),
        TRUE ~ cli::col_blue("**there is evidence for causality**")
      ),
      confounder_warning = if_else(E_Val_bound > 1,
                                   paste0("At this lower bound, unmeasured confounders would need a minimum association strength with both the intervention sequence and outcome of ", E_Val_bound, " to negate the observed effect. Weaker confounding would not overturn it. "),
                                   ""),
      outcome_interpretation = glue(
        "For '{outcome}', the effect estimate ({type}) is {causal_contrast} [{`2.5 %`}, {`97.5 %`}]. ",
        "The E-value for this estimate is {E_Value}, with a lower bound of {E_Val_bound}. ",
        "{confounder_warning}",
        "Here, {formatted_strength}."
      )
    )

  # Compile results
  interpretation_text <- paste(interpretation$outcome_interpretation, collapse = '\n\n')

  cli_alert_success("Interpretation completed successfully!")

  # Return results as a list
  return(list(
    estimand_description = estimand_description,
    interpretation = interpretation_text
  ))
}
